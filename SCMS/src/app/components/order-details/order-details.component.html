<ng-container *ngIf="order$ | async as order; else loading">
  <section class="order-details">
    <header class="header">
      <div>
        <h1>{{ order.title }}</h1>
        <p>
          رقم المعاملة:
          <span class="ref">{{ order.referenceNumber }}</span>
        </p>
      </div>
      <div class="chips">
        <span class="chip status {{ order.status }}">
          الحالة: {{ statusLabels[order.status] }}
        </span>
        <span class="chip priority {{ order.priority }}">
          الأولوية: {{ priorityLabels[order.priority] }}
        </span>
      </div>
    </header>

    <div class="details-grid">
      <article class="card">
        <h2>معلومات أساسية</h2>
        <ul>
          <li><strong>نوع المعاملة:</strong> {{ order.type === 'incoming' ? 'وارد' : 'صادر' }}</li>
          <li><strong>الإدارة:</strong> {{ order.departmentCode }}</li>
          <li><strong>الموضوع:</strong> {{ order.subjectCode }}</li>
          <li><strong>تاريخ الإنشاء:</strong> {{ order.createdAt | date: 'medium' }}</li>
          <li><strong>تاريخ التحديث:</strong> {{ order.updatedAt | date: 'medium' }}</li>
          <li *ngIf="order.dueDate"><strong>تاريخ الاستحقاق:</strong> {{ order.dueDate | date: 'mediumDate' }}</li>
        </ul>
      </article>

      <article class="card description">
        <h2>الوصف</h2>
        <p>{{ order.description }}</p>
      </article>

      <article class="card">
        <h2>الصلاحيات</h2>
        <ul>
          <li><strong>الرؤية:</strong> {{ order.permissions.isPublic ? 'عام' : order.permissions.canView.join(', ') }}</li>
          <li><strong>التعديل:</strong> {{ order.permissions.canEdit.join(', ') }}</li>
          <li><strong>الحذف:</strong> {{ order.permissions.canDelete.join(', ') }}</li>
          <li *ngIf="order.permissions.excludedUsers.length">
            <strong>مستخدمون مستثنون:</strong> {{ order.permissions.excludedUsers.join(', ') }}
          </li>
        </ul>
      </article>

      <article class="card attachments">
        <h2>المرفقات</h2>
        <ul>
          <li *ngFor="let attachment of order.attachments">
            <div>
              <strong>{{ attachment.fileName }}</strong>
              <small>({{ attachment.fileType }}, {{ attachment.fileSize | number }} بايت)</small>
            </div>
            <a [href]="attachment.fileUrl" target="_blank" rel="noopener">
              عرض
            </a>
          </li>
        </ul>
        <p *ngIf="!order.attachments.length">لا توجد مرفقات.</p>
      </article>
    </div>

    <footer class="actions">
      <a [routerLink]="['/orders/edit', order.id]" class="primary">تعديل المعاملة</a>
      <a routerLink="/orders" class="secondary">العودة إلى القائمة</a>
    </footer>
  </section>
</ng-container>

<ng-template #loading>
  <div class="loading">
    <p>جاري تحميل تفاصيل المعاملة...</p>
  </div>
</ng-template>

