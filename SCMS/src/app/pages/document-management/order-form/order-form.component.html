<section class="order-form">
  <header class="page-header">
    <h1>{{ isEditMode() === 'edit' ? 'تعديل المعاملة' : 'إنشاء معاملة جديدة' }}</h1>
    <p>
      أدخل تفاصيل المعاملة وحدد الإدارة والموضوع لضمان توليد رقم مرجعي صحيح.
    </p>
  </header>

  <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
    <div class="form-grid">
      <div class="field">
        <label>نوع المعاملة</label>
        <div class="radio-group">
          <label>
            <input type="radio" value="incoming" formControlName="type" />
            وارد
          </label>
          <label>
            <input type="radio" value="outgoing" formControlName="type" />
            صادر
          </label>
        </div>
      </div>

      <div class="field">
        <label for="department">الإدارة</label>
        <select id="department" formControlName="departmentId">
          <option value="" disabled>اختر الإدارة</option>
          <ng-container *ngIf="departments$ | async as departments">
            <option *ngFor="let department of departments" [value]="department.id">
              {{ department.code }} - {{ department.nameAr }}
            </option>
          </ng-container>
        </select>
        <small *ngIf="form.get('departmentId')?.invalid && form.get('departmentId')?.touched">
          اختيار الإدارة مطلوب.
        </small>
      </div>

      <div class="field">
        <label for="subject">الموضوع</label>
        <select id="subject" formControlName="subjectId">
          <option value="" disabled>اختر الموضوع</option>
          <option *ngFor="let subject of (subjects$ | async) ?? []" [value]="subject.id">
            {{ subject.code }} - {{ subject.nameAr }}
          </option>
        </select>
        <small *ngIf="form.get('subjectId')?.invalid && form.get('subjectId')?.touched">
          اختيار الموضوع مطلوب.
        </small>
      </div>

      <div class="field">
        <label for="title">العنوان</label>
        <input id="title" type="text" formControlName="title" placeholder="عنوان المعاملة" />
        <small *ngIf="form.get('title')?.invalid && form.get('title')?.touched">
          يجب إدخال عنوان مكوّن من 3 أحرف على الأقل.
        </small>
      </div>

      <div class="field description">
        <label for="description">الوصف</label>
        <textarea
          id="description"
          rows="4"
          formControlName="description"
          placeholder="تفاصيل المعاملة والقرارات المتعلقة بها"
        ></textarea>
        <small *ngIf="form.get('description')?.invalid && form.get('description')?.touched">
          يجب إدخال وصف مكوّن من 10 أحرف على الأقل.
        </small>
      </div>

      <div class="field">
        <label for="status">الحالة</label>
        <select id="status" formControlName="status">
          <option value="pending">قيد الانتظار</option>
          <option value="in-progress">قيد التنفيذ</option>
          <option value="completed">مكتملة</option>
          <option value="archived">مؤرشفة</option>
        </select>
      </div>

      <div class="field">
        <label for="priority">الأولوية</label>
        <select id="priority" formControlName="priority">
          <option value="low">منخفضة</option>
          <option value="medium">متوسطة</option>
          <option value="high">عالية</option>
          <option value="urgent">عاجلة</option>
        </select>
      </div>

      <div class="field">
        <label for="dueDate">تاريخ الاستحقاق</label>
        <input id="dueDate" type="date" formControlName="dueDate" />
      </div>

      <div class="field toggle">
        <label>
          <input type="checkbox" formControlName="isPublic" />
          المعاملة متاحة لجميع المستخدمين
        </label>
      </div>
    </div>

    <footer class="form-actions">
      <button type="submit" [disabled]="isSaving()">
        {{ isEditMode() === 'edit' ? 'تحديث المعاملة' : 'حفظ المعاملة' }}
      </button>
      <a routerLink="/orders" class="link">إلغاء</a>
    </footer>

    <p class="feedback" *ngIf="submissionMessage() as message">
      {{ message }}
    </p>
  </form>
</section>

