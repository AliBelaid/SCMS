<div class="container-fluid user-management">
  <!-- Page Header -->
  <div class="header-section">
    <div class="header-content">
      <h1 class="mat-headline-4">User Management</h1>
      <p class="mat-subtitle-1">Manage system users, roles, and permissions</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="createUser()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
        </svg>
        New User
      </button>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="stats-cards">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-value">{{dataSource?.data?.length || 0}}</div>
        <div class="stat-label">Total Users</div>
      </mat-card-content>
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z" fill="currentColor"/>
        </svg>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-value">{{getRoleCount('Admin')}}</div>
        <div class="stat-label">Administrators</div>
      </mat-card-content>
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 11.99H19C18.47 16.11 15.72 19.78 12 20.93V12H5V6.3L12 3.19V11.99Z" fill="currentColor"/>
        </svg>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-value">{{getRoleCount('Doctor')}}</div>
        <div class="stat-label">Doctors</div>
      </mat-card-content>
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 6H16V4C16 2.9 15.1 2 14 2H10C8.9 2 8 2.9 8 4V6H4C2.9 6 2 6.9 2 8V20C2 21.1 2.9 22 4 22H20C21.1 22 22 21.1 22 20V8C22 6.9 21.1 6 20 6ZM10 4H14V6H10V4ZM16 15H13V18H11V15H8V13H11V10H13V13H16V15Z" fill="currentColor"/>
        </svg>
      </div>
    </mat-card>
    
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-value">{{getRoleCount('Patient')}}</div>
        <div class="stat-label">Patients</div>
      </mat-card-content>
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 5.5C12.8284 5.5 13.5 6.17157 13.5 7C13.5 7.82843 12.8284 8.5 12 8.5C11.1716 8.5 10.5 7.82843 10.5 7C10.5 6.17157 11.1716 5.5 12 5.5ZM12 17C13.1 17 14 16.1 14 15V12C14 10.9 13.1 10 12 10C10.9 10 10 10.9 10 12V15C10 16.1 10.9 17 12 17ZM15 8.5C15.8284 8.5 16.5 9.17157 16.5 10C16.5 10.8284 15.8284 11.5 15 11.5C14.1716 11.5 13.5 10.8284 13.5 10C13.5 9.17157 14.1716 8.5 15 8.5ZM9 8.5C9.82843 8.5 10.5 9.17157 10.5 10C10.5 10.8284 9.82843 11.5 9 11.5C8.17157 11.5 7.5 10.8284 7.5 10C7.5 9.17157 8.17157 8.5 9 8.5ZM21 6H20.3C19.9 6 19.5 6.2 19.2 6.6L17.6 8.6C17.4 8.9 17 9 16.6 8.9L15.5 8.6C15 8.5 14.5 8.8 14.4 9.3L14 13.4C14 13.7 14.2 14 14.5 14.2L15.3 14.6C15.7 14.8 16.2 14.7 16.5 14.3L18.2 12C18.5 11.6 19 11.4 19.5 11.4H21C21.6 11.4 22 11 22 10.4V7C22 6.4 21.6 6 21 6ZM3 6H3.7C4.1 6 4.5 6.2 4.8 6.6L6.4 8.6C6.6 8.9 7 9 7.4 8.9L8.5 8.6C9 8.5 9.5 8.8 9.6 9.3L10 13.4C10 13.7 9.8 14 9.5 14.2L8.7 14.6C8.3 14.8 7.8 14.7 7.5 14.3L5.8 12C5.5 11.6 5 11.4 4.5 11.4H3C2.4 11.4 2 11 2 10.4V7C2 6.4 2.4 6 3 6Z" fill="currentColor"/>
        </svg>
      </div>
    </mat-card>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <mat-card>
      <mat-card-content>
        <div class="search-container">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search Users</mat-label>
            <input matInput [formControl]="searchCtrl" placeholder="Search by name, email, role...">
            <span matPrefix class="search-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="currentColor"/>
              </svg>
            </span>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filter by Role</mat-label>
            <mat-select (selectionChange)="filterByRole($event)">
              <mat-option value="">All Roles</mat-option>
              <mat-option value="Admin">Administrators</mat-option>
              <mat-option value="Doctor">Doctors</mat-option>
              <mat-option value="Patient">Patients</mat-option>
              <mat-option value="Pharmacy">Pharmacy</mat-option>
              <mat-option value="Reception">Reception</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Specialty</mat-label>
            <mat-select (selectionChange)="filterBySpecialty($event)">
              <mat-option value="">All Specialties</mat-option>
              <mat-option *ngFor="let specialty of specialties" [value]="specialty.id">
                {{specialty.specialtyName}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Users Table -->
  <div class="table-container">
    <mat-card>
      <mat-card-content>
        <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z0 user-table">
          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox (change)="$event ? masterToggle() : null"
                            [checked]="selection.hasValue() && isAllSelected()"
                            [indeterminate]="selection.hasValue() && !isAllSelected()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row">
              <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? selection.toggle(row) : null"
                            [checked]="selection.isSelected(row)">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- User Avatar Column -->
          <ng-container matColumnDef="avatar">
            <th mat-header-cell *matHeaderCellDef> Profile </th>
            <td mat-cell *matCellDef="let user">
              <div class="user-avatar">
                <img *ngIf="user.photoUrl" [src]="user.photoUrl" alt="User photo">
                <div *ngIf="!user.photoUrl" class="avatar-placeholder">
                  {{user.displayName?.charAt(0) || user.userName?.charAt(0) || 'U'}}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
            <td mat-cell *matCellDef="let user"> {{user.id}} </td>
          </ng-container>

          <!-- Username Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Username </th>
            <td mat-cell *matCellDef="let user"> 
              <div class="user-info">
                <span class="user-name">{{user.userName}}</span>
                <span class="user-email">{{user.email}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
            <td mat-cell *matCellDef="let user"> {{user.email}} </td>
          </ng-container>
          
          <!-- Roles Column -->
          <ng-container matColumnDef="roles">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Roles </th>
            <td mat-cell *matCellDef="let user"> 
              <div class="role-chips">
                <span *ngFor="let role of user.roles" class="role-chip" 
                      [ngClass]="{'admin-role': role === 'Admin', 
                                 'doctor-role': role === 'Doctor',
                                 'patient-role': role === 'Patient',
                                 'pharmacy-role': role === 'Pharmacy',
                                 'reception-role': role === 'Reception'}">
                  {{role}}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Specialties Column -->
          <ng-container matColumnDef="specialties">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Specialties </th>
            <td mat-cell *matCellDef="let user"> 
              <div class="specialty-chips">
                <span *ngFor="let specialty of user.specialties" class="specialty-chip">
                  {{specialty}}
                </span>
                <span *ngIf="!user.specialties?.length" class="no-specialty">
                  No specialties assigned
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
            <td mat-cell *matCellDef="let user"> 
              <span class="status-badge" [ngClass]="{'active-status': true}">
                Active
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let user">
              <div class="action-buttons">
                <button mat-icon-button [matMenuTriggerFor]="userMenu" aria-label="User actions">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 8C13.1 8 14 7.1 14 6C14 4.9 13.1 4 12 4C10.9 4 10 4.9 10 6C10 7.1 10.9 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM12 16C10.9 16 10 16.9 10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18C14 16.9 13.1 16 12 16Z" fill="currentColor"/>
                  </svg>
                </button>
                <mat-menu #userMenu="matMenu">
                  <button mat-menu-item (click)="openRolesDialog(user)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon">
                      <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 11.99H19C18.47 16.11 15.72 19.78 12 20.93V12H5V6.3L12 3.19V11.99Z" fill="currentColor"/>
                    </svg>
                    <span>Edit Roles</span>
                  </button>
                  <button mat-menu-item (click)="openDialogRestPassword(user)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon">
                      <path d="M12.63 2C8.96 2 6 4.96 6 8.63V12H8V8.63C8 6.07 10.07 4 12.63 4C15.19 4 17.25 6.07 17.25 8.63V12H19.25V8.63C19.25 4.96 16.29 2 12.63 2ZM17 13H7C5.9 13 5 13.9 5 15V21C5 22.1 5.9 23 7 23H17C18.1 23 19 22.1 19 21V15C19 13.9 18.1 13 17 13ZM12 18C10.9 18 10 17.1 10 16C10 14.9 10.9 14 12 14C13.1 14 14 14.9 14 16C14 17.1 13.1 18 12 18Z" fill="currentColor"/>
                    </svg>
                    <span>Reset Password</span>
                  </button>
                  <mat-divider></mat-divider>
                  <button mat-menu-item (click)="deleteCustomer(user)" class="delete-action">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon delete-icon">
                      <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
                    </svg>
                    <span>Delete User</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="visibleColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: visibleColumns;"
              class="user-row"
              [class.expanded-row]="expandedUser === row"
              (click)="expandedUser = expandedUser === row ? null : row">
          </tr>

          <!-- Expanded Content -->
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isExpansionDetailRow"
              class="detail-row"></tr>
        </table>

        <mat-paginator [pageSizeOptions]="pageSizeOptions" 
                      [pageSize]="pageSize"
                      showFirstLastButtons>
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Bulk Actions -->
  <div *ngIf="selection.selected.length > 0" class="bulk-actions">
    <mat-card>
      <mat-card-content>
        <span class="selected-count">{{selection.selected.length}} users selected</span>
        <button mat-button color="warn" (click)="deleteCustomers(selection.selected)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="button-icon">
            <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
          </svg>
          Delete Selected
        </button>
        <button mat-button color="primary">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="button-icon">
            <path d="M20 4H4C2.9 4 2.01 4.9 2.01 6L2 18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z" fill="currentColor"/>
          </svg>
          Send Email
        </button>
      </mat-card-content>
    </mat-card>
  </div>
</div> 