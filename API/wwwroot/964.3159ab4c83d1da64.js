"use strict";(self.webpackChunkvex=self.webpackChunkvex||[]).push([[964],{6964:(D,b,o)=>{o.d(b,{h:()=>U});var c=o(1626),u=o(4412),p=o(7673),S=o(8810),n=o(9437),h=o(8141),C=o(4668),v=o(1904),l=function(i){return i.CheckedIn="checkedin",i.CheckedOut="checkedout",i.Rejected="rejected",i.Cancelled="cancelled",i}(l||{}),m=function(i){return i.Today="today",i.Yesterday="yesterday",i.ThisWeek="week",i.ThisMonth="month",i.LastMonth="last_month",i.Custom="custom",i.All="all",i}(m||{}),f=o(4438);let U=(()=>{class i{constructor(t){this.http=t,this.apiUrl=v.c.apiUrl,this.visitsSubject=new u.t([]),this.departmentsSubject=new u.t([]),this.statsSubject=new u.t(null),this.loadingSubject=new u.t(!1),this.visits$=this.visitsSubject.asObservable(),this.departments$=this.departmentsSubject.asObservable(),this.stats$=this.statsSubject.asObservable(),this.loading$=this.loadingSubject.asObservable(),this.cache=new Map,this.cacheTTL=3e5,this.loadInitialData()}loadInitialData(){this.loadDepartments().subscribe()}getVisitorByIdentifier(t,e){const s=(new c.Nl).set("nationalId",t||"").set("phone",e||"");return this.http.get(`${this.apiUrl}/Visitors/lookup`,{params:s}).pipe((0,n.W)(this.handleError))}getVisitorProfile(t){const e=`visitor-profile-${t}`,s=this.getFromCache(e);return s?(0,p.of)(s):this.http.get(`${this.apiUrl}/Visitors/${t}/profile`).pipe((0,h.M)(r=>this.setCache(e,r)),(0,n.W)(this.handleError))}updateVisitorBlockStatus(t,e){return this.http.put(`${this.apiUrl}/Visitors/${t}/block`,e).pipe((0,h.M)(()=>this.invalidateCache(`visitor-profile-${t}`)),(0,n.W)(this.handleError))}searchVisitors(t){const e=(new c.Nl).set("query",t);return this.http.get(`${this.apiUrl}/Visitors/search`,{params:e}).pipe((0,n.W)(this.handleError))}getVisitors(t,e){let s=new c.Nl;return t&&(s=s.set("departmentId",t.toString())),e&&(s=s.set("search",e)),this.http.get(`${this.apiUrl}/Visitors`,{params:s}).pipe((0,n.W)(this.handleError))}getVisitorProfileDetailed(t){const e=`visitor-profile-detailed-${t}`,s=this.getFromCache(e);return s?(0,p.of)(s):this.http.get(`${this.apiUrl}/Visitors/${t}/profile`).pipe((0,h.M)(r=>this.setCache(e,r,12e4)),(0,n.W)(this.handleError))}createVisitor(t){return this.http.post(`${this.apiUrl}/Visitors`,t).pipe((0,h.M)(()=>{this.clearCache()}),(0,n.W)(this.handleError))}getActiveVisits(t){this.loadingSubject.next(!0);let e=new c.Nl;return t&&(e=e.set("search",t)),this.http.get(`${this.apiUrl}/Visits/active`,{params:e}).pipe((0,h.M)(s=>{this.visitsSubject.next(s),this.loadingSubject.next(!1)}),(0,n.W)(s=>(this.loadingSubject.next(!1),this.handleError(s))))}getVisitHistory(t){this.loadingSubject.next(!0);let e=new c.Nl;return t&&(e=e.set("search",t)),this.http.get(`${this.apiUrl}/Visits/history`,{params:e}).pipe((0,h.M)(()=>this.loadingSubject.next(!1)),(0,n.W)(s=>(this.loadingSubject.next(!1),this.handleError(s))))}getVisitByNumber(t){return this.http.get(`${this.apiUrl}/Visits/number/${t}`).pipe((0,n.W)(this.handleError))}createVisit(t){return this.loadingSubject.next(!0),this.http.post(`${this.apiUrl}/Visits`,t).pipe((0,h.M)(e=>{this.visitsSubject.next([e,...this.visitsSubject.value]),this.loadingSubject.next(!1),this.invalidateStatsCache()}),(0,n.W)(e=>(this.loadingSubject.next(!1),this.handleError(e))))}blockVisitor(t,e,s){return this.http.put(`${this.apiUrl}/Visitors/${t}/block`,{isBlocked:e,blockReason:s}).pipe((0,h.M)(()=>{this.invalidateCache("visitors"),this.invalidateCache(`visitor-${t}`)}),(0,n.W)(this.handleError))}checkoutVisit(t){return this.http.post(`${this.apiUrl}/Visits/checkout/${t}`,{}).pipe((0,h.M)(e=>{const s=this.visitsSubject.value,r=s.findIndex(a=>a.visitNumber===t);-1!==r&&(s[r]=e,this.visitsSubject.next([...s])),this.invalidateStatsCache()}),(0,n.W)(this.handleError))}updateVisit(t,e){return this.http.put(`${this.apiUrl}/Visits/${t}`,e).pipe((0,h.M)(s=>{const r=this.visitsSubject.value,a=r.findIndex(d=>d.visitNumber===t);-1!==a&&(r[a]=s,this.visitsSubject.next([...r]))}),(0,n.W)(this.handleError))}cancelVisit(t,e){return this.http.post(`${this.apiUrl}/Visits/${t}/cancel`,{reason:e}).pipe((0,h.M)(()=>this.invalidateStatsCache()),(0,n.W)(this.handleError))}getRecentVisits(t=10){const e=(new c.Nl).set("count",t.toString());return this.http.get(`${this.apiUrl}/Visits/recent`,{params:e}).pipe((0,n.W)(this.handleError))}searchVisits(t){const e=(new c.Nl).set("search",t);return this.http.get(`${this.apiUrl}/Visits/search`,{params:e}).pipe((0,n.W)(this.handleError))}loadDepartments(){const t="departments",e=this.getFromCache(t);return e?(this.departmentsSubject.next(e),(0,p.of)(e)):this.http.get(`${this.apiUrl}/VisitorDepartments`).pipe((0,h.M)(s=>{this.departmentsSubject.next(s),this.setCache(t,s)}),(0,C.t)(1),(0,n.W)(this.handleError))}getDepartmentById(t){return this.http.get(`${this.apiUrl}/VisitorDepartments/${t}`).pipe((0,n.W)(this.handleError))}getDashboardStats(){const t="dashboard-stats",e=this.getFromCache(t);return e?(this.statsSubject.next(e),(0,p.of)(e)):this.http.get(`${this.apiUrl}/Visits/stats`).pipe((0,h.M)(s=>{this.statsSubject.next(s),this.setCache(t,s,12e4)}),(0,n.W)(this.handleError))}getHourlyDistribution(t){let e=new c.Nl;return t&&(e=e.set("date",t.toISOString())),this.http.get(`${this.apiUrl}/Visits/hourly-distribution`,{params:e}).pipe((0,n.W)(this.handleError))}getVisitsByPeriod(t,e,s){let r=(new c.Nl).set("period",t);return t===m.Custom&&e&&s&&(r=r.set("dateFrom",e.toISOString()),r=r.set("dateTo",s.toISOString())),this.http.get(`${this.apiUrl}/Visits/by-period`,{params:r}).pipe((0,n.W)(this.handleError))}filterVisits(t,e){let s=[...t];if(e.searchTerm){const r=e.searchTerm.toLowerCase();s=s.filter(a=>a.visitNumber.toLowerCase().includes(r)||a.visitorName.toLowerCase().includes(r)||a.departmentName.toLowerCase().includes(r)||a.employeeToVisit.toLowerCase().includes(r)||a.carPlate&&a.carPlate.toLowerCase().includes(r))}if(e.departmentId&&(s=s.filter(r=>r.departmentId===e.departmentId)),e.status&&"all"!==e.status&&(s=s.filter(r=>r.status===e.status)),e.dateFrom){const r=new Date(e.dateFrom);s=s.filter(a=>new Date(a.checkInAt)>=r)}if(e.dateTo){const r=new Date(e.dateTo);s=s.filter(a=>new Date(a.checkInAt)<=r)}return e.createdByUserId&&(s=s.filter(r=>r.createdByUserId===e.createdByUserId)),void 0!==e.hasCarPlate&&(s=s.filter(r=>e.hasCarPlate?!!r.carPlate:!r.carPlate)),s}getPaginatedVisits(t,e){let s=new c.Nl;return t&&(t.searchTerm&&(s=s.set("search",t.searchTerm)),t.departmentId&&(s=s.set("departmentId",t.departmentId.toString())),t.status&&"all"!==t.status&&(s=s.set("status",t.status)),t.dateFrom&&(s=s.set("dateFrom",t.dateFrom.toISOString())),t.dateTo&&(s=s.set("dateTo",t.dateTo.toISOString())),t.createdByUserId&&(s=s.set("createdBy",t.createdByUserId.toString())),void 0!==t.hasCarPlate&&(s=s.set("hasCarPlate",t.hasCarPlate.toString()))),e&&(s=s.set("pageNumber",e.pageNumber.toString()),s=s.set("pageSize",e.pageSize.toString()),e.sortBy&&(s=s.set("sortBy",e.sortBy)),e.sortOrder&&(s=s.set("sortOrder",e.sortOrder))),this.http.get(`${this.apiUrl}/Visits/paginated`,{params:s}).pipe((0,n.W)(this.handleError))}generateReport(t,e,s,r){const a={reportType:t,dateFrom:e.toISOString(),dateTo:s.toISOString(),filters:r};return this.http.post(`${this.apiUrl}/Visits/reports/generate`,a).pipe((0,n.W)(this.handleError))}exportVisits(t){return this.http.post(`${this.apiUrl}/Visits/export`,t,{responseType:"blob"}).pipe((0,n.W)(this.handleError))}downloadExport(t,e){const s=window.URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=e,r.click(),window.URL.revokeObjectURL(s)}printVisitorBadge(t){return this.http.get(`${this.apiUrl}/Visits/${t}/badge`,{responseType:"blob"}).pipe((0,n.W)(this.handleError))}formatDuration(t,e){const s=new Date(t),a=(e?new Date(e):new Date).getTime()-s.getTime(),d=Math.floor(a/36e5),g=Math.floor(a%36e5/6e4);return d>0?`${d}\u0633 ${g}\u062f`:`${g}\u062f`}getTimeSince(t){const e=new Date,s=new Date(t),r=e.getTime()-s.getTime(),a=Math.floor(r/6e4);if(a<1)return"\u0627\u0644\u0622\u0646";if(a<60)return`\u0645\u0646\u0630 ${a} \u062f\u0642\u064a\u0642\u0629`;const d=Math.floor(a/60);return d<24?`\u0645\u0646\u0630 ${d} \u0633\u0627\u0639\u0629`:`\u0645\u0646\u0630 ${Math.floor(d/24)} \u064a\u0648\u0645`}getStatusLabel(t){const e=t;switch(e?.toLowerCase()){case"checkedin":case l.CheckedIn:case"ongoing":return"\u062c\u0627\u0631\u064a\u0629";case"checkedout":case l.CheckedOut:case"completed":return"\u0645\u0643\u062a\u0645\u0644\u0629";case"rejected":case l.Rejected:case"incomplete":return"\u0645\u0631\u0641\u0648\u0636\u0629";case"cancelled":case l.Cancelled:return"\u0645\u0644\u063a\u0627\u0629";default:return e||"\u063a\u064a\u0631 \u0645\u0639\u0631\u0648\u0641"}}getStatusColor(t){switch(t?.toLowerCase()){case"checkedin":case l.CheckedIn:case"ongoing":return"primary";case"checkedout":case l.CheckedOut:case"completed":return"accent";case"rejected":case l.Rejected:case"incomplete":return"warn";default:return""}}getFromCache(t){const e=this.cache.get(t);return e?new Date>e.expiresAt?(this.cache.delete(t),null):e.data:null}setCache(t,e,s=this.cacheTTL){const r=new Date,a=new Date(r.getTime()+s);this.cache.set(t,{data:e,timestamp:r,expiresAt:a})}invalidateCache(t){this.cache.delete(t)}invalidateStatsCache(){this.invalidateCache("dashboard-stats")}clearCache(){this.cache.clear()}handleError(t){console.error("Visitor Management Service Error:",t);let e="\u062d\u062f\u062b \u062e\u0637\u0623 \u063a\u064a\u0631 \u0645\u062a\u0648\u0642\u0639";if(t.error instanceof ErrorEvent)e=`\u062e\u0637\u0623: ${t.error.message}`;else if(t.status)switch(t.status){case 400:e=t.error?.message||"\u0628\u064a\u0627\u0646\u0627\u062a \u063a\u064a\u0631 \u0635\u062d\u064a\u062d\u0629";break;case 401:e="\u063a\u064a\u0631 \u0645\u0635\u0631\u062d - \u064a\u0631\u062c\u0649 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644";break;case 403:e="\u0644\u064a\u0633 \u0644\u062f\u064a\u0643 \u0635\u0644\u0627\u062d\u064a\u0629 \u0644\u0644\u0642\u064a\u0627\u0645 \u0628\u0647\u0630\u0627 \u0627\u0644\u0625\u062c\u0631\u0627\u0621";break;case 404:e="\u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629 \u063a\u064a\u0631 \u0645\u0648\u062c\u0648\u062f\u0629";break;case 500:e="\u062e\u0637\u0623 \u0641\u064a \u0627\u0644\u062e\u0627\u062f\u0645 - \u064a\u0631\u062c\u0649 \u0627\u0644\u0645\u062d\u0627\u0648\u0644\u0629 \u0644\u0627\u062d\u0642\u0627\u064b";break;default:e=t.error?.message||`\u062e\u0637\u0623: ${t.status}`}return(0,S.$)(()=>({statusCode:t.status||0,message:e,details:t.error?.details||t.message,timestamp:new Date}))}refreshAllData(){this.clearCache(),this.loadDepartments().subscribe(),this.getDashboardStats().subscribe(),this.getActiveVisits().subscribe()}getCurrentVisits(){return this.visitsSubject.value}getCurrentDepartments(){return this.departmentsSubject.value}getCurrentStats(){return this.statsSubject.value}static{this.\u0275fac=function(e){return new(e||i)(f.KVO(c.Qq))}}static{this.\u0275prov=f.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})()}}]);