import{a as f}from"./chunk-2XM6XD6I.js";import{ua as v}from"./chunk-I6ZOHNIY.js";import{b as U}from"./chunk-EWVCNHQE.js";import{a as p,d as g}from"./chunk-ONA5LIIU.js";import{A as h,Y as l,ba as d,f as u,ga as o}from"./chunk-LPVC7MPI.js";var j=(()=>{class r{constructor(e,i,s,a){this.authService=e,this.signalRService=i,this.router=s,this.snackBar=a,this.destroy$=new u,this.joinedUserCode=null,console.log("RoleMonitorService: Initializing..."),this.authService.currentUser$.pipe(l(this.destroy$)).subscribe(n=>{if(n){console.log("RoleMonitorService: User logged in, ensuring SignalR connection. User:",n.code),this.signalRService.startConnection();let t=n.code??null,c=n.description??null;this.joinedUserCode&&this.joinedUserCode!==t&&this.signalRService.leaveUserGroup(this.joinedUserCode),t&&t!==this.joinedUserCode&&setTimeout(()=>this.signalRService.joinUserGroup(t),500),this.joinedUserCode=t,c&&c!==t&&setTimeout(()=>this.signalRService.joinUserGroup(c),600)}else this.joinedUserCode&&(this.signalRService.leaveUserGroup(this.joinedUserCode),this.joinedUserCode=null),this.signalRService.stopConnection()}),this.setupRoleChangeListening(),this.setupRouteMonitoring()}setupRoleChangeListening(){this.signalRService.subscribeToNotifications(e=>{e.type==="roleChanged"&&this.handleRoleChangeNotification(e.data)})}handleRoleChangeNotification(e){let i=this.authService.getCurrentUser();if(!i)return;let s=i.code===e.userCode,a=i.description===e.userCode;(s||a)&&this.handleCurrentUserRoleChange(e)}handleCurrentUserRoleChange(e){if(!this.authService.getCurrentUser())return;console.log("RoleMonitor: Handling role change for current user:",e),this.authService.updateUserRole(e.newRole),console.log("RoleMonitor: Broadcasting role change to all subscribers");let s=e.newRole==="Uploader"?"\u062A\u0645 \u062A\u0631\u0642\u064A\u062A\u0643 \u0625\u0644\u0649 \u0631\u0627\u0641\u0639 \u0645\u0644\u0641\u0627\u062A! \u064A\u0645\u0643\u0646\u0643 \u0627\u0644\u0622\u0646 \u0631\u0641\u0639 \u0627\u0644\u0645\u0644\u0641\u0627\u062A.":"\u062A\u0645 \u062A\u063A\u064A\u064A\u0631 \u062F\u0648\u0631\u0643 \u0625\u0644\u0649 \u0639\u0636\u0648 \u0639\u0627\u062F\u064A. \u0644\u0646 \u062A\u062A\u0645\u0643\u0646 \u0645\u0646 \u0631\u0641\u0639 \u0627\u0644\u0645\u0644\u0641\u0627\u062A.";this.snackBar.open(s,"\u0625\u063A\u0644\u0627\u0642",{duration:6e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["success-snackbar"]}),this.handleAutoNavigation(e.newRole)}handleAutoNavigation(e){let i=this.router.url;i.includes("/admin/upload")&&e==="Member"&&this.router.navigate(["/files"]).then(()=>{this.snackBar.open("\u062A\u0645 \u062A\u062D\u0648\u064A\u0644\u0643 \u0625\u0644\u0649 \u0635\u0641\u062D\u0629 \u0627\u0644\u0645\u0644\u0641\u0627\u062A \u0644\u0623\u0646\u0643 \u0644\u0645 \u062A\u0639\u062F \u062A\u0645\u0644\u0643 \u0635\u0644\u0627\u062D\u064A\u0629 \u0627\u0644\u0631\u0641\u0639.","\u0645\u0648\u0627\u0641\u0642",{duration:8e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["warning-snackbar"]})}),i.includes("/admin/")&&!this.authService.canUploadFiles()&&!this.authService.isAdmin()&&this.router.navigate(["/files"]).then(()=>{this.snackBar.open("\u062A\u0645 \u062A\u062D\u0648\u064A\u0644\u0643 \u0625\u0644\u0649 \u0635\u0641\u062D\u0629 \u0627\u0644\u0645\u0644\u0641\u0627\u062A \u0644\u0639\u062F\u0645 \u0648\u062C\u0648\u062F \u0635\u0644\u0627\u062D\u064A\u0627\u062A \u0625\u062F\u0627\u0631\u064A\u0629.","\u0645\u0648\u0627\u0641\u0642",{duration:6e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["warning-snackbar"]})}),e==="Uploader"&&setTimeout(()=>{this.snackBar.open("\u064A\u0645\u0643\u0646\u0643 \u0627\u0644\u0622\u0646 \u0627\u0644\u0648\u0635\u0648\u0644 \u0625\u0644\u0649 \u0635\u0641\u062D\u0629 \u0631\u0641\u0639 \u0627\u0644\u0645\u0644\u0641\u0627\u062A!","\u0625\u063A\u0644\u0627\u0642",{duration:5e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["success-snackbar"]})},1500)}checkCurrentUserPermissions(){let e=this.authService.getCurrentUser();return this.router.url.includes("/admin/upload")&&!this.authService.canUploadFiles()?(this.snackBar.open("\u0644\u064A\u0633 \u0644\u062F\u064A\u0643 \u0635\u0644\u0627\u062D\u064A\u0629 \u0644\u0631\u0641\u0639 \u0627\u0644\u0645\u0644\u0641\u0627\u062A!","\u0625\u063A\u0644\u0627\u0642",{duration:5e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["error-snackbar"]}),this.router.navigate(["/files"]),!1):!0}setupRouteMonitoring(){this.router.events.pipe(h(e=>e instanceof p),l(this.destroy$)).subscribe(()=>{this.checkCurrentPagePermissions()})}checkCurrentPagePermissions(){let e=this.router.url;this.authService.getCurrentUser()&&(e.includes("/admin/upload")&&!this.authService.canUploadFiles()&&(console.log("RoleMonitor: User lost upload permission, redirecting from upload page"),this.router.navigate(["/files"]).then(()=>{this.snackBar.open("\u062A\u0645 \u0645\u0646\u0639\u0643 \u0645\u0646 \u0627\u0644\u0648\u0635\u0648\u0644 \u0644\u0635\u0641\u062D\u0629 \u0627\u0644\u0631\u0641\u0639 \u0644\u0639\u062F\u0645 \u0648\u062C\u0648\u062F \u0627\u0644\u0635\u0644\u0627\u062D\u064A\u0629 \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629.","\u0645\u0648\u0627\u0641\u0642",{duration:6e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["error-snackbar"]})})),e.includes("/admin/users")&&!this.authService.isAdmin()&&(console.log("RoleMonitor: User lost admin permission, redirecting from users page"),this.router.navigate(["/files"]).then(()=>{this.snackBar.open("\u062A\u0645 \u0645\u0646\u0639\u0643 \u0645\u0646 \u0627\u0644\u0648\u0635\u0648\u0644 \u0644\u0635\u0641\u062D\u0629 \u0625\u062F\u0627\u0631\u0629 \u0627\u0644\u0645\u0633\u062A\u062E\u062F\u0645\u064A\u0646 \u0644\u0639\u062F\u0645 \u0648\u062C\u0648\u062F \u0635\u0644\u0627\u062D\u064A\u0629 \u0627\u0644\u0645\u062F\u064A\u0631.","\u0645\u0648\u0627\u0641\u0642",{duration:6e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["error-snackbar"]})})))}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}static{this.\u0275fac=function(i){return new(i||r)(o(U),o(f),o(g),o(v))}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{j as a};
